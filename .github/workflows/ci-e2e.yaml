name: E2e-tests
on:
  workflow_dispatch:
    inputs:
      plan_identifiers:
        description: 'Comma separated list of plan identifiers'
        required: true
        default: 'sunnydale'
      frontend_base_url:
        description: 'Base url for environment to run tests against'
        required: true
        default: 'http://{planId}.watch.staging.kausal.tech'
      backend_base_url:
        description: 'Base url for backend API'
        required: true
        default: 'https://api.watch.kausal.tech/v1'

jobs:
  e2e_test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/yarn.lock') }}

      - name: Install yarn
        run: |
          corepack enable
          yarn set version 3.2.1
          yarn config set nodeLinker 'node-modules'
          yarn config set npmScopes.kausal.npmRegistryServer "${{ secrets.NPM_REGISTRY_SERVER }}"
          yarn config set npmScopes.kausal.npmAlwaysAuth true
          yarn config set npmScopes.kausal.npmAuthIdent ${{ secrets.NPM_AUTH_IDENT }}

      - name: Install dependencies
        run: yarn install

      - name: Playwright install
        run: node_modules/.bin/playwright install

      - name: Install WebKit dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwoff2dec.so.1.0.2 || true
          sudo apt-get install -y libvpx.so.7 || true
          sudo apt-get install -y libevent-2.1.so.7 || true
          sudo apt-get install -y libopus.so.0 || true
          sudo apt-get install -y libharfbuzz-icu.so.0 || true
          sudo apt-get install -y libgstallocators-1.0.so.0 || true
          sudo apt-get install -y libgstapp-1.0.so.0 || true
          sudo apt-get install -y libgstpbutils-1.0.so.0 || true
          sudo apt-get install -y libgstaudio-1.0.so.0 || true
          sudo apt-get install -y libgsttag-1.0.so.0 || true
          sudo apt-get install -y libgstvideo-1.0.so.0 || true
          sudo apt-get install -y libgstgl-1.0.so.0 || true
          sudo apt-get install -y libgstcodecparsers-1.0.so.0 || true
          sudo apt-get install -y libgstfft-1.0.so.0 || true
          sudo apt-get install -y libhyphen.so.0 || true
          sudo apt-get install -y libmanette-0.2.so.0 || true
          sudo apt-get install -y libflite.so.1 || true
          sudo apt-get install -y libflite_usenglish.so.1 || true
          sudo apt-get install -y libflite_cmu_grapheme_lang.so.1 || true
          sudo apt-get install -y libflite_cmu_grapheme_lex.so.1 || true
          sudo apt-get install -y libflite_cmu_indic_lang.so.1 || true
          sudo apt-get install -y libflite_cmu_indic_lex.so.1 || true
          sudo apt-get install -y libflite_cmulex.so.1 || true
          sudo apt-get install -y libflite_cmu_time_awb.so.1 || true
          sudo apt-get install -y libflite_cmu_us_awb.so.1 || true
          sudo apt-get install -y libflite_cmu_us_kal16.so.1 || true
          sudo apt-get install -y libflite_cmu_us_kal.so.1 || true
          sudo apt-get install -y libflite_cmu_us_rms.so.1 || true
          sudo apt-get install -y libflite_cmu_us_slt.so.1 || true
          sudo apt-get install -y libGLESv2.so.2 || true
          sudo apt-get install -y libx264.so || true

      - name: Running Playwright e2e tests
        run: node_modules/.bin/playwright test
        env:
          TEST_PLAN_IDENTIFIERS: ${{ github.event.inputs.plan_identifiers }}
          TEST_PAGE_BASE_URL: ${{ github.event.inputs.frontend_base_url }}
          APLANS_API_BASE_URL: ${{ github.event.inputs.backend_base_url }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 5
